Number,Content
Sentence 1,"picture of nitzan yaakov nitzan yaakov july 07, 2022
8220 gang deploys a new campaign with upgraded techniques
a recent campaign by the 8220 gang, who have been known to exploit the newly discovered critical confluence vulnerability (cve-2022-26134), targeted one of our honeypots."
Sentence 2,this campaign has evolved over time to deliberately target containers.
Sentence 3,"in this game of cat and mouse, the threat actors used some new techniques, refurbishing the scripts from one attack to another, adding new capabilities to attack the compromised host, and spreading the attack to additional hosts."
Sentence 4,"in this blog, we’ll break down this attack, review its techniques, and analyze it using a runtime detection and prevention tool."
Sentence 5,"here's what we're going to cover:
initial access
execution and persistence techniques
defense evasion techniques
discovery techniques
lateral movement techniques
command and control techniques
impact techniques
the malware execution
detecting the attack

jira_confluence_flow_ok

figure 1: jira?confluence attack flow (8220 gang)

initial access
in the aforementioned attack, threat actors exploited a misconfigured docker daemon to run a vanilla alpine image combined with a malicious command to perform the attack."
Sentence 6,the command consists of multiple download commands from a remote server via the shell script jira?confluence.
Sentence 7,this command-and-control (c2) server was used by the attackers throughout the whole attack.
Sentence 8,the name of the shell script is interesting since it’s reminiscent of an event in june when a new vulnerability was discovered that allows remote code execution on confluence servers.
Sentence 9,the vulnerability was added to the national vulnerability database (nvd) as cve-2022-26134.
Sentence 10,"it affects several versions of confluence servers and data centers, allowing an unauthenticated attacker to execute arbitrary code and exploit vulnerable versions."
Sentence 11,"during our investigation, we discovered similarities (apart from the indicative name) in both code and artifacts between attacks that exploited the confluence vulnerability and the attack that was caught against our honeypots."
Sentence 12,"the functions in code, binaries, and c2 infrastructure are most commonly associated with the 8220 gang."
Sentence 13,the container command that was executed on our honeypot is very interesting since it contains a snippet that materializes a download function as a fallback in case the relevant applications on the target host fail to download the main payload from the c2 server.
Sentence 14,"running a vanilla container image with a commandfigure 2: running a vanilla container image with a command

as you can see in the screenshot above, the attackers are running alpine with a command."
Sentence 15,"they are trying to change the root directory to /mnt directory by using the command chroot /mnt and running three options of remote file download (curl, wget, and lwp-download)."
Sentence 16,the latter is less known and aims to download large files from the web.
Sentence 17,"as a fallback, the command also creates a temporary directory in /tmp/jira, writes an encoded snippet in base64, then decodes and executes it."
Sentence 18,"decoded base64 (from jira?confluence shell script)figure 3: decoded base64 

the screenshot above is the decoded snippet that appeared in the command."
Sentence 19,"as you can see, the attacker deletes a temporary file in /var/tmp/.dat and inserts a function that is aimed to replace curl or wget, namely to download files from the web."
Sentence 20,"below you can see the code in /var/tmp/.dat:

download function (from jira?confluence shell script)figure 4: download function (from jira?confluence shell script)

finally, you can see that this last snippet is a materialization of a download function serving as a fallback in case curl, wget, and lwp-download fail."
Sentence 21,"execution and persistence techniques
the main payload in this attack is the jira?confluence shell script, which is executed in our case in the container."
Sentence 22,the attacker creates a schedule job using cron jobs to facilitate the initial execution of the malicious shell script.
Sentence 23,"there’s also a fallback function, which the attacker uses as a backup to the cron-job to guarantee the execution of the malicious code on the compromised machine."
Sentence 24,"ultimately, the threat actor is trying to create several cron jobs in various locations, which aim to download the main payload from the c2 server and execute it."
Sentence 25,"the threat actor uses randomize functions to start automatically on boot time, which assures the execution of the shell script on the machine."
Sentence 26,"this, in turn, allows persistence in case the attack is detected and stopped."
Sentence 27,"makecron function (from jira?confluence shell script)figure 5: makecron function (from jira?confluence shell script)

as you can see in the screenshot below, the threat actor is using another function — cronbackup — as a backup to the cron job, a method derived from the attacker’s goal to maintain a foothold on the target machine."
Sentence 28,"cronbackup function (from jira?confluence shell script)figure 6: cronbackup function (from jira?confluence shell script)

this fallback function also checks if cron, crond, and atd are active."
Sentence 29,"if the first two work, then the function ends."
Sentence 30,"if they aren’t active while atd is active, the code is designed to insert during the scheduled cron invocation, an invocation of the payload."
Sentence 31,"lastly, if none of the above are active, the attacker defines an infinite loop that executes the payload every five minutes randomly in one of four paths."
Sentence 32,"defense evasion techniques
in this case, the attacker is shutting down the security tools of alibaba cloud, baidu cloud, and google cloud platform (gcp)."
Sentence 33,this is done to evade detection and increase the chances of a successful attack.
Sentence 34,"run function (from jira?confluence shell script)figure 7: run function (from jira?confluence shell script)

two interesting functions are judge and judge2, which are designed to run malware while checking if they aren’t blocked by the target system."
Sentence 35,we’ll get to them later in the malware execution section.
Sentence 36,"judge and judge2 functions (from jira?confluence shell script)figure 8: judge and judge2 functions (from jira?confluence shell script)

furthermore, the attacker also uses various defense evasion techniques."
Sentence 37,these include disabling the uncomplicated firewall (ufw) program and setting new iptables rules to ensure inbound and outbound traffic to and from c2 servers.
Sentence 38,"moreover, the attacker changes selinux mode to permissive using the setenforce 0 command, which enables him to skip any security policies."
Sentence 39,selinux is a security module in linux that provides a mechanism for supporting access control security policies.
Sentence 40,"defense evasion techniques (from jira?confluence shell script)figure 9: defense evasion techniques (from jira?confluence shell script)

additionally, the attacker removes attributes from the /etc/ld.so.preload file:

setting the option that the file can be modified
setting the option that the file can be opened for writing data in append mode only
afterward, the attacker has also deleted the content of /ect/ld.so.preload, probably to block any security components that are set to be loaded before any other libraries."
Sentence 41,"after downloading the shell script to the compromised machine, it’s saved in the /tmp directory."
Sentence 42,this is probably done to avoid detection by agentless solutions that are blind to files written to the tmp directory and memory.
Sentence 43,"the attacker modifies the directory permissions to make sure any user will have read, write, and execute permissions."
Sentence 44,"the attacker is also checking if outbound communication is blocked by firewall or other security components — first, by trying to ping a c2 server that hides behind a domain name (‘jira[.]letmaker[.]top’)."
Sentence 45,"if the domain name is blocked, the attacker will use the ip address directly."
Sentence 46,"second, by resolving the cryptomining pool with dns, if it’s blocked, the malware is instructed with a flag."
Sentence 47,"checking communication towards c2 server and cryptomining pool (from jira?confluence shell script)figure 10: checking communication towards c2 server & cryptomining pool (from jira?confluence shell script)

lastly, the attacker also deletes log files to hide any suspicious activity within the system:

cron logs
wtmp file that contains the history of all logins and logouts
a secure log file that contains information related to authentication and authorization privileges."
Sentence 48,"/var/spool/mail/root, which includes messages from tasks that ran during the attack on the compromised machine and wrote their output to this path
 

logs deletion (from jira?confluence shell script)figure 11: logs deletion (from jira?confluence shell script)

discovery techniques
in this scenario, the threat actor is running several scanners to detect and find further targets in the local network, brute-forcing to the ssh service or collecting ssh keys from the current target to get into other hosts."
Sentence 49,"in the screenshot below, you can see one example in the scan function where the attacker is downloading three components — masscan, spirit, and px — to conduct brute force to ssh service in the local environment."
Sentence 50,"with masscan, a powerful scanner, the threat actor is scanning 10.0.0.0/8, 172.16.0.0.12, and 192.168.0.0/16 for running open ssh service on port 22.

the ascii files px and pasx (not in the screenshot) are serving as a configuration file for the binary spirit and spirit-pro."
Sentence 51,"we’ll examine the ssh brute force later in the malware section

scan function (from jira?confluence shell script)figure 12: scan function (from jira?confluence shell script)

moreover, the attacker is matching the binary in the c2 to the target processor architecture by using the command uname -m.

lateral movement techniques
the attacker then propagates his attack, initiating it against additional hosts to abuse them."
Sentence 52,"the attacker harnesses the components he downloaded earlier, helping move the malicious code through the internal environment of the compromised machine."
Sentence 53,the attacker tries to spread his attack using two methods.
Sentence 54,"in the first one, after discovering vulnerable hosts via a ssh open port, the attacker can initiate ssh brute force against those hosts."
Sentence 55,"if it succeeds, he executes the malicious shell script and continues spreading the attack."
Sentence 56,"in the second method, the attacker exploits previous connections established between the compromised machine and remote hosts."
Sentence 57,this data can be found in various files on the host.
Sentence 58,"for example, the known hosts' file of previous ssh connections."
Sentence 59,the connection is established using a key known to both machines and used as an identification that the connection is legit.
Sentence 60,the attacker uses the details saved on the compromised host required to establish the connection – details of the remote host and ssh key to pair between the machines.
Sentence 61,"the attacker creates a loop that generates all combinations of keys, hosts, and users."
Sentence 62,"in case the details are correct, the attacker builds the connection to the remote host:

he provides read permissions and removes all other permissions to the key list."
Sentence 63,"he changes the settings of how host keys are checked (keyhostkeychecking), which allows adding the client host key to the known hosts’ list even if the key isn’t defined as known."
Sentence 64,"he changes the settings of batchmode, making it possible to log in to the remote host and execute commands without the password."
Sentence 65,"finally, the attacker executes the malicious shell script on the remote host, spreading his attack."
Sentence 66,"localgo function (from jira?confluence shell script)figure 13: localgo function (from jira?confluence shell script)

command-and-control techniques
the attacker may also set up communication channels with his c2 to extend control over the compromised machine."
Sentence 67,the attacker can use the connection to a c2 server and initiate a reverse shell to allow remote access to the compromised machine.
Sentence 68,"moreover, the attacker can determine whether the tsunami malware is currently running on the machine by checking the connection with the irc server (51[.]255[.]171[.]23)."
Sentence 69,"if this connection isn’t there, the tsunami malware would then be downloaded and executed."
Sentence 70,the ip address 51[.]255[.]171[.
Sentence 71,]23 is marked as malicious and has been identified in a campaign that exploits the latest confluence cve-2022-26134.
Sentence 72,we’ll look at how the tsunami malware works later in the blog.
Sentence 73,"figure 14

figure 14: checking availability of irc protocol (from jira?confluence shell script)

impact techniques
all the techniques that the attackers have been using throughout the attack allowed them to reach their ultimate goal – to use the machine’s cpu to mine cryptocurrency."
Sentence 74,"the attacker modifies the setting of sysctl and enables hugepages, a feature that allows the operating system to support memory pages greater than the default."
Sentence 75,this technique can accelerate the hash rate (mining speed) by 20-30%.
Sentence 76,"figure 15: modifies attributes of the system kernel (from jira?confluence shell script)figure 15: modifies attributes of the system kernel (from jira?confluence shell script)

the malware execution
the techniques we reviewed above enabled the attacker to build the foundations to execute the attack."
Sentence 77,"in this section, we’ll examine the binaries and files and their role in the attack."
Sentence 78,the artifacts are the first downloads of the functions judge() and judge2().
Sentence 79,the attacker adjusts the artifact’s download according to the machine’s architecture to make sure it would run properly.
Sentence 80,"first, the attacker downloads a packed (upx) malware named dbused (md5=eb2f5e1b8f818cf6a7dafe78aea62c93 and md5=780965bad574e4e7f04433431d0d8f63)."
Sentence 81,the malware serves as a cryptominer and is associated with the 8220 gang.
Sentence 82,"next, the attacker downloads the bashirc file (md5: 63a86932a5bad5da32ebd1689aa814b3 and md5: 0ba9e6dcfc7451e386704b2846b7e440) known as the tsunami malware, which is used as a linux backdoor that allows remote access to the infected machine."
Sentence 83,the tsunami malware uses internet relay chat (irc) protocol to control as a client for distributed denial of service attacks (ddos) on targeted systems and therefore is considered as an irc bot.
Sentence 84,"to exploit related machines and infect them as well, the attacker initiates a scan function and downloads from the remote server the following tools:

spirit binary file (md5:cba8efad5eda067ef9d10d372a9a9cab and md5: 9a934b00a07847c66b9ddf7268b07dd3)
px text file
masscan binary file (md5: eefc0ce93d254982fbbcd26460f3d10d)
the attackers are looking for more vulnerable machines on the same network as the infected machine."
Sentence 85,"by scanning the internal network with the masscan tool, they search for open ssh ports (22)."
Sentence 86,"with a list of the relevant hosts, the spirit binary, which is a upx file, functions as an ssh scanner tool and uses a px text file, which contains more than 10,000 records of usernames and passwords."
Sentence 87,then it initiates a brute force attack against the vulnerable hosts found in the same network to spread the attack and infect them as well.
Sentence 88,the attacker also tries to spread his attack to remote hosts using known pair host keys from previous connections performed from the infected machines.
Sentence 89,"in case the connection is established, the attacker executes his malicious shell script and infects those machines as well."
Sentence 90,"over the past few days, we examined some changes that the attackers made to the script."
Sentence 91,they’ve added more functions that allow them to hide malicious activities and successfully launch the attack.
Sentence 92,"the jira?confluence shell script, which initiates the attack on the compromised machine, was updated with the following new components:

users and passwords file – the attacker has updated the px file with the pasx (md5=3cd845610e49e11575b5c18596b38389) file."
Sentence 93,ssh scanner – the attacker has updated the ssh scanner tool used spirit to spirit-pro (md5=389437dc4db73256913b8d89fab5e7bc and md5=7d72ccaf59619d0011ca02f97ecb1170).
Sentence 94,"ssh brute-force tool – the attacker added a new tool called hxx (md5=f0551696774f66ad3485445d9e3f7214), which is used to perform ssh brute-force attacks and is found related to the 8220 gang."
Sentence 95,"detecting the attack
the story behind this campaign is simple."
Sentence 96,"when a new critical zero-day vulnerability is detected, malicious actors are rushing to exploit it as quickly as possible and your workloads in production are immediately at risk."
Sentence 97,you need to go over them one by one to evaluate if they are vulnerable and can be exploited.
Sentence 98,"attackers, however, only need to tweak their tools and add the new exploit to their massive botnets."
Sentence 99,"so, you might lose this race."
Sentence 100,runtime detection and response tools such as aqua’s cloud native detection and response (cndr) are built to detect malicious or suspicious behavior in runtime.
Sentence 101,"if one of your running workloads is vulnerable to the confluence vulnerability, cndr will let you see the following detections:

screen shot 2022-07-05 at 13.39.41

figure 16: cndr dashboard

let’s start with the dashboard."
Sentence 102,"it shows that over the last hour, we had various detections in our environment."
Sentence 103,"moving forward to our incident screen, we see these nine detections:

incidents view

figure 17: cndr incidents view

when inspecting these detections, we find out that they are aligned with the attack that we’ve just described above."
Sentence 104,"figure-18

figure 18: examples of cndr detections

we can easily reconstruct the attack kill chain."
Sentence 105,"this can be a hard task when doing incident response, but cndr allows us to go over the attack step-by-step:

19a

19b

19c

figure 19: attack kill chain

mapping these campaigns to the mitre att&ck framework
here we map each component of the attack to the corresponding techniques of the mitre att&ck framework:
mitre atta&ck framework


conclusion
this attack emphasizes the continuous evolution of attackers, who are adding new techniques to bypass security tools, successfully expand the attack to additional hosts, and amplify the impact."
Sentence 106,"within just a few days, the shell script we've been investigating has gained new features and binaries."
Sentence 107,the improvement of the script is designed to spread the attack more efficiently across the local network and remote hosts.
Sentence 108,"attacks like this are growing both in number and sophistication, involving new capabilities and tools."
Sentence 109,"to protect against these kinds of attacks, we recommend following these guidelines:

make sure to properly configure your environment and avoid exposing unnecessary ports."
Sentence 110,follow security announcements and update your systems to the latest releases.
Sentence 111,monitor container activity to help mitigate issues quickly and minimize disruptions.
Sentence 112,this also applies to the runtime environment where suspicious activity can occur.
Sentence 113,"in our case, the attack was initiated using the vanilla image alpine:latest, which most organizations use and allow to run in their environments."
Sentence 114,runtime protection solutions such as aqua’s cndr are built to detect unknown threats and suspicious behavior during runtime.
Sentence 115,"moreover, drift prevention would have blocked the execution of the file that was downloaded from a remote source during runtime and that wasn’t part of the original container image."
Sentence 116,"indicators of compromise (iocs)
name

type

md5

dbuser (x86_64)

binary

eb2f5e1b8f818cf6a7dafe78aea62c93

dbuser (i686)

binary

780965bad574e4e7f04433431d0d8f63

bashirc (x86_64)

binary

63a86932a5bad5da32ebd1689aa814b3

bashirc (i686)

binary

0ba9e6dcfc7451e386704b2846b7e440

spirit (upx)

binary

cba8efad5eda067ef9d10d372a9a9cab

spirit

binary

9a934b00a07847c66b9ddf7268b07dd3

spirit-pro (upx)

binary

389437dc4db73256913b8d89fab5e7bc

spirit-pro

binary

7d72ccaf59619d0011ca02f97ecb1170

hxx

binary

f0551696774f66ad3485445d9e3f7214

masscan

binary

eefc0ce93d254982fbbcd26460f3d10d

px

text file

26935a6763559c954cd247efcfa71a47

pasx

text file

3cd845610e49e11575b5c18596b38389

jira?confluence

shell script

ed325c84233a432e06a548c131a91a69

ips and domains

51.255.171.23

89.34.27.167

167.114.114.169

jira.letmaker.top"
